<!DOCTYPE html>
<html>
<head>
    <title>py_home Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }
        h1 { color: #58a6ff; font-size: 32px; }
        .last-updated { color: #8b949e; font-size: 14px; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }
        .card-wide {
            grid-column: span 4;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .status-row:last-child { border-bottom: none; }
        .status-label { color: #8b949e; }
        .status-value {
            color: #c9d1d9;
            font-weight: 500;
        }
        .status-good { color: #3fb950; }
        .status-warning { color: #d29922; }
        .status-error { color: #f85149; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-online {
            background: #1a472a;
            color: #3fb950;
        }
        .badge-offline {
            background: #3d1f1f;
            color: #f85149;
        }
        .badge-home {
            background: #1a472a;
            color: #3fb950;
        }
        .badge-away {
            background: #392f1a;
            color: #d29922;
        }
        .temp-display {
            font-size: 36px;
            font-weight: 700;
            color: #58a6ff;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        .error {
            color: #f85149;
            padding: 15px;
            background: #3d1f1f;
            border: 1px solid #f85149;
            border-radius: 6px;
        }
        .refresh-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }
        .log-preview {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 10px;
        }
        .view-logs-link {
            display: inline-block;
            color: #58a6ff;
            text-decoration: none;
            font-size: 13px;
            margin-top: 5px;
        }
        .view-logs-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† py_home Dashboard</h1>
            <div>
                <span class="last-updated" id="lastUpdated">Loading...</span>
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh</button>
            </div>
        </header>

        <div id="dashboard">
            <div class="loading">Loading dashboard...</div>
        </div>
    </div>

    <script>
        // Fetch with timeout helper
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function loadDashboard() {
            const dashboardEl = document.getElementById('dashboard');
            const lastUpdatedEl = document.getElementById('lastUpdated');

            try {
                // Load all status data in parallel
                const [nest, sensibo, tapo, tempstick, presence, systemStatus, logs] = await Promise.all([
                    fetchNestStatus(),
                    fetchSensiboStatus(),
                    fetchTapoStatus(),
                    fetchTempStickStatus(),
                    fetchPresence(),
                    fetchSystemStatus(),
                    fetchAutomationLogs()
                ]);

                // Build dashboard HTML
                dashboardEl.innerHTML = `
                    <div class="grid">
                        ${renderNestCard(nest)}
                        ${renderSensiboCard(sensibo)}
                        ${renderTempStickCard(tempstick)}
                        ${renderTapoCard(tapo)}
                        ${renderPresenceCard(presence)}
                        ${renderSystemCard(systemStatus)}
                        ${renderLogsCard(logs)}
                    </div>
                `;

                lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                dashboardEl.innerHTML = `
                    <div class="error">Failed to load dashboard: ${error.message}</div>
                `;
            }
        }

        async function fetchNestStatus() {
            try {
                const response = await fetchWithTimeout('/api/nest/status', 10000);
                if (response.ok) {
                    const data = await response.json();
                    data._stale = false;
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    current_temp_f: 0,
                    mode: 'UNKNOWN',
                    hvac_status: 'ERROR'
                };
            }

            // Fallback mock data
            return {
                current_temp_f: 72.5,
                mode: 'HEAT',
                heat_setpoint_f: 72,
                hvac_status: 'OFF',
                humidity: 52,
                _stale: false,
                _error: false
            };
        }

        async function fetchSensiboStatus() {
            try {
                const response = await fetchWithTimeout('/api/sensibo/status', 10000);
                if (response.ok) {
                    const data = await response.json();
                    data._stale = false;
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    on: false,
                    mode: 'unknown',
                    current_temp_f: 0
                };
            }

            return {
                on: true,
                mode: 'heat',
                target_temp_f: 70,
                current_temp_f: 70.0,
                current_humidity: 65.6,
                _stale: false,
                _error: false
            };
        }

        async function fetchTapoStatus() {
            try {
                const response = await fetchWithTimeout('/api/tapo/status', 30000);
                if (response.ok) {
                    const data = await response.json();
                    data._stale = false;
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    devices: []
                };
            }

            return {
                devices: [
                    {name: 'Livingroom Lamp', on: true},
                    {name: 'Bedroom Left Lamp', on: true},
                    {name: 'Bedroom Right Lamp', on: true},
                    {name: 'Heater', on: false}
                ],
                _stale: false,
                _error: false
            };
        }

        async function fetchTempStickStatus() {
            try {
                const response = await fetchWithTimeout('/api/tempstick/status', 10000);
                if (response.ok) {
                    const data = await response.json();
                    data._stale = false;
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    temperature_f: 0,
                    humidity: 0,
                    is_online: false
                };
            }

            return {
                temperature_f: 72.0,
                humidity: 45.0,
                battery_pct: 100,
                is_online: true,
                sensor_name: 'TempStick',
                _stale: false,
                _error: false
            };
        }

        async function fetchPresence() {
            try {
                const response = await fetchWithTimeout('/api/presence', 5000);
                if (response.ok) {
                    const data = await response.json();

                    // Check staleness (5 minutes = 300 seconds)
                    if (data.age_seconds !== null && data.age_seconds > 300) {
                        data._stale = true;
                    } else {
                        data._stale = false;
                    }
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    state: 'unknown',
                    is_home: null
                };
            }

            return {
                is_home: null,
                state: 'unknown',
                source: 'unknown',
                _stale: true,
                _error: false
            };
        }

        async function fetchSystemStatus() {
            try {
                const response = await fetchWithTimeout('/api/system-status', 5000);
                if (response.ok) {
                    const data = await response.json();
                    data._stale = false;
                    data._error = false;
                    return data;
                }
            } catch (e) {
                return {
                    _error: true,
                    error: e.message,
                    status: 'error',
                    flask_uptime: 'unknown',
                    night_mode: false,
                    automations_enabled: false
                };
            }

            return {
                status: 'unknown',
                flask_uptime: 'unknown',
                night_mode: false,
                automations_enabled: true,
                _stale: false,
                _error: false
            };
        }

        async function fetchAutomationLogs() {
            try {
                const response = await fetchWithTimeout('/logs/automations.log?lines=20&format=text', 5000);
                if (response.ok) {
                    const text = await response.text();
                    // Reverse lines so newest appears first
                    const reversedText = text.trim().split('\\n').reverse().join('\\n');
                    return {
                        content: reversedText,
                        _error: false
                    };
                }
            } catch (e) {
                return {
                    content: '',
                    _error: true,
                    error: e.message
                };
            }

            return {
                content: 'No logs available',
                _error: false
            };
        }

        function formatAge(ageSeconds) {
            if (ageSeconds === null) return 'unknown';
            if (ageSeconds < 60) return `${Math.round(ageSeconds)}s ago`;
            if (ageSeconds < 3600) return `${Math.round(ageSeconds / 60)}m ago`;
            return `${Math.round(ageSeconds / 3600)}h ago`;
        }

        function renderNestCard(data) {
            const statusClass = data.hvac_status === 'OFF' ? 'status-good' : 'status-warning';
            const staleWarning = data._stale ? '<div class="status-row"><span class="status-warning">‚ö†Ô∏è Data may be stale</span></div>' : '';
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading data</span></div>' : '';

            // Determine target temperature display
            let targetTemp = '';
            if (data.eco_mode === 'MANUAL_ECO' && data.eco_heat_f && data.eco_cool_f) {
                // In ECO mode: show range
                targetTemp = `ECO (${data.eco_heat_f}-${data.eco_cool_f}¬∞F)`;
            } else if (data.heat_setpoint_f) {
                targetTemp = `${data.heat_setpoint_f}¬∞F`;
            } else if (data.cool_setpoint_f) {
                targetTemp = `${data.cool_setpoint_f}¬∞F`;
            } else {
                targetTemp = 'N/A';
            }

            return `
                <div class="card">
                    <div class="card-title">üè† Nest Thermostat</div>
                    ${errorWarning}
                    ${staleWarning}
                    <div class="temp-display">${data.current_temp_f}¬∞F</div>
                    <div class="status-row">
                        <span class="status-label">Mode</span>
                        <span class="status-value">${data.mode}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Target</span>
                        <span class="status-value">${targetTemp}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">HVAC</span>
                        <span class="status-value ${statusClass}">${data.hvac_status}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Humidity</span>
                        <span class="status-value">${data.current_humidity != null ? data.current_humidity + '%' : 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        function renderSensiboCard(data) {
            const hvacStatus = data.on ? 'RUNNING' : 'OFF';
            const statusClass = data.on ? 'status-warning' : 'status-good';
            const staleWarning = data._stale ? '<div class="status-row"><span class="status-warning">‚ö†Ô∏è Data may be stale</span></div>' : '';
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading data</span></div>' : '';

            return `
                <div class="card">
                    <div class="card-title">üõèÔ∏è Sensibo AC (Master Suite)</div>
                    ${errorWarning}
                    ${staleWarning}
                    <div class="temp-display">${data.current_temp_f}¬∞F</div>
                    <div class="status-row">
                        <span class="status-label">Mode</span>
                        <span class="status-value">${data.mode.toUpperCase()}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Target</span>
                        <span class="status-value">${data.target_temp_f}¬∞F</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">HVAC</span>
                        <span class="status-value ${statusClass}">${hvacStatus}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Humidity</span>
                        <span class="status-value">${data.current_humidity != null ? data.current_humidity + '%' : 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        function renderTempStickCard(data) {
            const statusBadge = data.is_online ? 'badge-online' : 'badge-offline';
            const statusText = data.is_online ? 'ONLINE' : 'OFFLINE';
            const staleWarning = data._stale ? '<div class="status-row"><span class="status-warning">‚ö†Ô∏è Data may be stale</span></div>' : '';
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading data</span></div>' : '';

            // Battery level color
            let batteryClass = 'status-good';
            if (data.battery_pct < 20) batteryClass = 'status-error';
            else if (data.battery_pct < 50) batteryClass = 'status-warning';

            return `
                <div class="card">
                    <div class="card-title">üå°Ô∏è Crawl Space</div>
                    ${errorWarning}
                    ${staleWarning}
                    <div class="temp-display">${data.temperature_f}¬∞F</div>
                    <div class="status-row">
                        <span class="status-label">Humidity</span>
                        <span class="status-value">${data.humidity}%</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Battery</span>
                        <span class="status-value ${batteryClass}">${data.battery_pct}%</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Sensor</span>
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </div>
                </div>
            `;
        }

        function renderTapoCard(data) {
            const staleWarning = data._stale ? '<div class="status-row"><span class="status-warning">‚ö†Ô∏è Data may be stale</span></div>' : '';
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading data</span></div>' : '';

            return `
                <div class="card">
                    <div class="card-title">üí° Smart Outlets</div>
                    ${errorWarning}
                    ${staleWarning}
                    ${data.devices.map(device => `
                        <div class="status-row">
                            <span class="status-label">${device.name}</span>
                            <span class="badge ${device.on ? 'badge-online' : 'badge-offline'}">
                                ${device.on ? 'ON' : 'OFF'}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPresenceCard(data) {
            const locationBadge = data.is_home === true ? 'badge-home' :
                                  data.is_home === false ? 'badge-away' : 'badge-offline';
            const locationText = data.is_home === true ? 'HOME' :
                                 data.is_home === false ? 'AWAY' : 'UNKNOWN';

            // Check if data is stale (>5 minutes)
            const isStale = data.age_seconds !== null && data.age_seconds > 300;
            const ageText = formatAge(data.age_seconds);
            const staleClass = isStale ? 'status-warning' : '';
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading presence</span></div>' : '';

            // Map source to user-friendly name
            const sourceMap = {
                'presence_monitor': 'iOS Geofencing',
                'legacy': 'iOS Geofencing',
                'unknown': 'Unknown'
            };
            const sourceName = sourceMap[data.source] || data.source || 'Unknown';

            return `
                <div class="card">
                    <div class="card-title">üìç Presence</div>
                    ${errorWarning}
                    <div class="status-row">
                        <span class="status-label">Status</span>
                        <span class="badge ${locationBadge}">${locationText}</span>
                    </div>
                    ${data.last_updated ? `
                        <div class="status-row">
                            <span class="status-label">Last Checked</span>
                            <span class="status-value ${staleClass}">${isStale ? '‚ö†Ô∏è ' : ''}${ageText}</span>
                        </div>
                    ` : ''}
                    <div class="status-row">
                        <span class="status-label">Source</span>
                        <span class="status-value">${sourceName}</span>
                    </div>
                </div>
            `;
        }

        function renderSystemCard(data) {
            const modeBadge = data.night_mode ? 'badge-warning' : 'badge-online';
            const modeText = data.night_mode ? 'NIGHT MODE' : 'DAY MODE';

            const statusBadge = data.status === 'operational' ? 'badge-online' :
                               data.status === 'degraded' ? 'badge-warning' : 'badge-offline';
            const statusText = data.status === 'operational' ? 'OPERATIONAL' :
                              data.status === 'degraded' ? 'DEGRADED' : 'ERROR';

            const automationsBadge = data.automations_enabled ? 'badge-online' : 'badge-offline';
            const automationsText = data.automations_enabled ? 'ENABLED' : 'DISABLED';

            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading system status</span></div>' : '';

            return `
                <div class="card">
                    <div class="card-title">‚öôÔ∏è System</div>
                    ${errorWarning}
                    <div class="status-row">
                        <span class="status-label">Status</span>
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Mode</span>
                        <span class="badge ${modeBadge}">${modeText}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Automations</span>
                        <span class="badge ${automationsBadge}">${automationsText}</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Flask Uptime</span>
                        <span class="status-value">${data.flask_uptime || 'unknown'}</span>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #21262d;">
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <button
                                onclick="toggleAutomations(${data.automations_enabled})"
                                id="automationToggleBtn"
                                style="
                                    flex: 1;
                                    background: ${data.automations_enabled ? '#392f1a' : '#1a472a'};
                                    border: 1px solid ${data.automations_enabled ? '#d29922' : '#3fb950'};
                                    color: ${data.automations_enabled ? '#d29922' : '#3fb950'};
                                    padding: 8px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 600;
                                "
                                onmouseover="this.style.opacity='0.8'"
                                onmouseout="this.style.opacity='1'"
                            >
                                ${data.automations_enabled ? '‚è∏Ô∏è Disable Automations' : '‚ñ∂Ô∏è Enable Automations'}
                            </button>
                            <button
                                onclick="controlService('restart')"
                                style="
                                    flex: 1;
                                    background: #21262d;
                                    border: 1px solid #30363d;
                                    color: #c9d1d9;
                                    padding: 8px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 600;
                                "
                                onmouseover="this.style.background='#30363d'"
                                onmouseout="this.style.background='#21262d'"
                            >
                                üîÑ Restart Flask
                            </button>
                        </div>
                        <button
                            onclick="shutdownPi()"
                            id="shutdownBtn"
                            style="
                                width: 100%;
                                background: #3d1f1f;
                                border: 1px solid #f85149;
                                color: #f85149;
                                padding: 10px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            "
                            onmouseover="this.style.background='#4a2626'"
                            onmouseout="this.style.background='#3d1f1f'"
                        >
                            üîå Shutdown Pi
                        </button>
                        <div id="serviceStatus" style="margin-top: 10px; text-align: center; font-size: 12px; color: #8b949e;"></div>
                    </div>
                </div>
            `;
        }

        function renderLogsCard(data) {
            const errorWarning = data._error ? '<div class="status-row"><span class="status-error">‚ùå Error loading logs</span></div>' : '';
            const logContent = data.content || 'No logs available';

            return `
                <div class="card card-wide">
                    <div class="card-title">üìú Recent Activity</div>
                    ${errorWarning}
                    <div class="log-preview">${logContent}</div>
                    <a href="/logs" class="view-logs-link">View Full Logs ‚Üí</a>
                </div>
            `;
        }

        async function controlService(action) {
            const status = document.getElementById('serviceStatus');
            const actionText = action === 'stop' ? 'Stop' : action === 'restart' ? 'Restart' : 'Start';

            if (!confirm(`${actionText} Flask server?\\n\\n${action === 'stop' ? 'Dashboard will become unavailable.' : action === 'restart' ? 'Dashboard will reload in ~5 seconds.' : 'Flask will start.'}`)) {
                return;
            }

            status.innerHTML = `<span style="color: #d29922;">‚è≥ ${actionText}ing Flask...</span>`;

            try {
                const response = await fetch('/api/service-control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await response.json();

                if (response.ok) {
                    status.innerHTML = `<span style="color: #3fb950;">‚úì ${actionText} initiated</span>`;

                    if (action === 'restart') {
                        setTimeout(() => {
                            status.innerHTML = '<span style="color: #d29922;">‚è≥ Waiting for Flask...</span>';
                            setTimeout(() => window.location.reload(), 5000);
                        }, 2000);
                    } else if (action === 'stop') {
                        clearInterval(window.dashboardRefreshInterval);
                        setTimeout(() => {
                            status.innerHTML = '<span style="color: #8b949e;">Flask stopped. Refresh page to reconnect.</span>';
                        }, 2000);
                    }
                } else {
                    status.innerHTML = `<span style="color: #f85149;">‚ùå ${data.message || 'Failed'}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span style="color: #f85149;">‚ùå ${error.message}</span>`;
            }
        }

        async function toggleAutomations(currentlyEnabled) {
            const status = document.getElementById('serviceStatus');
            const action = currentlyEnabled ? 'disable' : 'enable';

            if (!confirm(`${action === 'disable' ? 'Disable' : 'Enable'} all automations?\\n\\n${action === 'disable' ? 'Home automations will stop running but dashboard stays active.' : 'Home automations will resume normal operation.'}`)) {
                return;
            }

            status.innerHTML = `<span style="color: #d29922;">‚è≥ ${action === 'disable' ? 'Disabling' : 'Enabling'} automations...</span>`;

            try {
                const response = await fetch('/api/automation-control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: !currentlyEnabled })
                });
                const data = await response.json();

                if (response.ok) {
                    status.innerHTML = `<span style="color: #3fb950;">‚úì Automations ${action === 'disable' ? 'disabled' : 'enabled'}</span>`;
                    // Reload dashboard to show new status
                    setTimeout(() => loadDashboard(), 1000);
                } else {
                    status.innerHTML = `<span style="color: #f85149;">‚ùå ${data.message || 'Failed'}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span style="color: #f85149;">‚ùå ${error.message}</span>`;
            }
        }

        async function shutdownPi() {
            const btn = document.getElementById('shutdownBtn');
            const status = document.getElementById('serviceStatus');

            if (!confirm('Shutdown the Raspberry Pi?\\n\\nThe system will power down. Wait for the LED to stop blinking before unplugging power.')) {
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Shutting down...';
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';

            try {
                const response = await fetch('/api/shutdown', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    status.innerHTML = '<span style="color: #d29922;">‚ö†Ô∏è System shutting down<br>Wait for LED to stop blinking<br>Then safe to unplug power</span>';

                    // Stop auto-refresh
                    clearInterval(window.dashboardRefreshInterval);

                    // Show countdown
                    let seconds = 60;
                    const countdown = setInterval(() => {
                        status.innerHTML = `<span style="color: #d29922;">‚ö†Ô∏è Shutdown in progress (${seconds}s)<br>LED will stop blinking soon<br>Then safe to unplug</span>`;
                        seconds--;
                        if (seconds < 0) {
                            clearInterval(countdown);
                            status.innerHTML = '<span style="color: #3fb950;">‚úì System halted<br>LED should be OFF<br>Safe to unplug power now</span>';
                        }
                    }, 1000);
                } else {
                    status.innerHTML = `<span style="color: #f85149;">‚ùå ${data.message || 'Shutdown failed'}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'üîå Shutdown Pi';
                    btn.style.cursor = 'pointer';
                    btn.style.opacity = '1';
                }
            } catch (error) {
                status.innerHTML = `<span style="color: #f85149;">‚ùå ${error.message}</span>`;
                btn.disabled = false;
                btn.textContent = 'üîå Shutdown Pi';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
            }
        }

        // Load dashboard on page load
        loadDashboard();

        // Auto-refresh every 5 seconds
        window.dashboardRefreshInterval = setInterval(loadDashboard, 5000);
    </script>
</body>
</html>
